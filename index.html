<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dmitry ‚Äî Personal Money Tracker</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='42'>‚ÇΩ</text></svg>">
<style>
/* ===========================
   –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò + –ê–î–ê–ü–¢–ò–í 
   =========================== */
:root{
  --bg:#fafafa;
  --card:#ffffff;
  --ink:#111;
  --muted:#666;
  --line:#eaeaea;
  --ok:#1f8b4c;
  --warn:#cc7a00;
  --bad:#c0392b;
  --accent:#2d6cdf;
  --radius:12px;
  --gap:16px;
  --shadow:0 2px 10px rgba(0,0,0,.06);
  --fs-base:clamp(14px, 1.4vw, 16px);
  --fs-sm:clamp(12px, 1.2vw, 14px);
  --fs-lg:clamp(16px, 1.6vw, 18px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:400 var(--fs-base)/1.45 "SF Pro Display", -apple-system, system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif;
  /* ‚ñº –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∂–∏—Ä–Ω–æ—Å—Ç–∏ –Ω–∞ macOS/iOS –∏ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö */
  font-weight:400;
  font-synthesis: none;              /* –∑–∞–ø—Ä–µ—Ç —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å fake-bold/italic */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}
.container{max-width:1200px; margin:0 auto; padding:20px;}
h1{font-size:clamp(20px,2.6vw,28px); margin:0 0 12px}
h2{font-size:clamp(18px,2.2vw,22px); margin:0 0 12px}
h3{font-size:clamp(16px,2vw,20px); margin:0 0 10px}
.muted{color:var(--muted)}
.row{display:grid; gap:var(--gap)}
@media (min-width:640px){
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  .row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow); padding:16px;
}
.card-title{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.badge{font-size:var(--fs-sm); padding:2px 8px; border-radius:999px; background:#f2f6ff; border:1px solid #dbe7ff; color:#1f4fbf}
.kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
.kpi{padding:12px; border:1px solid var(--line); border-radius:10px}
.kpi b{font-size:var(--fs-lg); font-weight:600}
.progress{height:10px; background:#f1f1f1; border-radius:999px; overflow:hidden; border:1px solid var(--line)}
.progress > i{display:block; height:100%; background:linear-gradient(90deg, #6aa3ff, #2d6cdf)}
.grid-accounts{display:grid; gap:12px}
@media (min-width:640px){ .grid-accounts{grid-template-columns:repeat(5,1fr)} }
.account{border:1px solid var(--line); border-radius:10px; padding:12px;}
.account h4{margin:0 0 8px; font-size:var(--fs-lg)}
.account .sum{font-weight:700}
.account .hint{font-size:var(--fs-sm); color:var(--muted)}

/* –ü–û–î–ü–ò–°–ò –ò –ò–ù–ü–£–¢–´ ‚Äî –í–ê–ñ–ù–´–ï –û–¢–°–¢–£–ü–´ */
label{
  font-size:var(--fs-sm); color:var(--muted);
  display:flex; flex-direction:column;
  gap:8px;             /* –ø–æ–¥–ø–∏—Å—å ‚Üí –∏–Ω–ø—É—Ç = 8px */
  margin-bottom:12px;  /* –±–ª–æ–∫–∏ —Ñ–æ—Ä–º = 12px */
}
input, select, textarea{
  width:100%; min-height:48px;
  padding:12px 14px; border:1px solid var(--line); border-radius:8px; background:#fff; color:#111;
  font:inherit;
  font-weight:400; /* –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ–º "–∂–∏—Ä–Ω–æ—Å—Ç–∏" –Ω–∞ iOS */
}

/* –ö–û–ù–¢–†–û–õ–´ –ò –ö–ù–û–ü–ö–ò: –í –†–Ø–î –ò –û–î–ù–û–ô –í–´–°–û–¢–´ */
.controls{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
button{
  padding:10px 14px; border-radius:8px; border:1px solid #d4e1ff; background:#eaf1ff;
  color:#1f4fbf; font-weight:600; cursor:pointer; min-height:40px;
}
button.primary{border-color:#2d6cdf; background:#2d6cdf; color:#fff}
button.danger{border-color:#ffddd9; background:#ffeceb; color:#b22a1f}
button.ghost{background:#fff; border-color:var(--line); color:#111}

/* –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ ‚Äî –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é, –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
.card .card-title .controls{
  display:flex; flex-wrap:nowrap; gap:8px; overflow:auto; padding-top:2px;
}
.card .card-title .controls button{
  display:inline-flex; align-items:center; justify-content:center;
  height:44px; min-height:44px; padding:0 16px; line-height:1; white-space:nowrap; flex:0 0 auto;
}
.card .card-title .controls label{ display:inline-flex; align-items:center; gap:8px; }

hr{border:none; border-top:1px solid var(--line); margin:12px 0}

/* ======= –¢–ê–ë–õ–ò–¶–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ô ======= */
.table{width:100%; border-collapse:collapse; table-layout:auto;}
.table th,.table td{
  border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:var(--fs-sm); vertical-align:middle;
  font-weight:400; /* –±–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ç–∞–±–ª–∏—Ü—ã ‚Äî –æ–±—ã—á–Ω—ã–π */
}
.table th{color:var(--muted); font-weight:600}

/* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞—Ç—É –∏ ¬´–°—á–µ—Ç–∞¬ª */
#txTable td:nth-child(1),   /* –î–∞—Ç–∞ */
#txTable td:nth-child(3) {  /* –°—á–µ—Ç–∞ */
  white-space:nowrap;
  min-width:120px;
}
#txTable td:nth-child(3){ min-width:180px; }

/* ‚ñº –ü–†–ê–í–ö–ê: ¬´–ö–∞—Ç–µ–≥–æ—Ä–∏—è¬ª –∏ ¬´–ó–∞–º–µ—Ç–∫–∞¬ª ‚Äî –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –±–µ–∑ —Ç—Ä–æ–µ—Ç–æ—á–∏–π */
#txTable td:nth-child(5),
#txTable td:nth-child(6){
  white-space:nowrap;     /* –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ */
}
/* –°–Ω–∏–º–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã –∏ —Ç—Ä–æ–µ—Ç–æ—á–∏—è —É ¬´–ó–∞–º–µ—Ç–∫–∏¬ª */
#txTable td:nth-child(6){ max-width:none; }
#txTable td:nth-child(6) .note-clip{
  display:inline;         /* inline-—ç–ª–µ–º–µ–Ω—Ç */
  white-space:inherit;    /* –Ω–∞—Å–ª–µ–¥—É–µ–º nowrap –æ—Ç —è—á–µ–π–∫–∏ */
  overflow:visible;       /* –Ω–µ –æ–±—Ä–µ–∑–∞–µ–º */
  text-overflow:clip;     /* –±–µ–∑ —Ç—Ä–æ–µ—Ç–æ—á–∏–π */
}

/* –•–æ–≤–µ—Ä-—Ç–µ–≥–∏ –∏ –º–µ–ª–æ—á–∏ */
.tag{display:inline-block; padding:2px 8px; font-size:var(--fs-sm); border:1px solid var(--line); border-radius:999px}
.help{font-size:var(--fs-sm); color:var(--muted)}
footer{margin:24px 0; text-align:center; color:var(--muted); font-size:var(--fs-sm)}

/* ¬´–ú–æ–¥–∞–ª–∫–∏¬ª –Ω–∞ <details> */
details.modal{border:1px solid var(--line); border-radius:var(--radius); padding:12px}
details.modal > summary{cursor:pointer; list-style:none; font-weight:700}
details.modal > summary::-webkit-details-marker{display:none}
.summary-row{display:flex; align-items:center; justify-content:space-between; gap:8px}

/* –¢–û–ß–ö–ê –ë–û–õ–ò: 3-–π —Å—Ç–æ–ª–±–µ—Ü ‚Äî –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ —Ä–æ–≤–Ω–æ 12px */
.row.cols-3>.card:nth-child(3) details.modal .row,
.row.cols-3>.card:nth-child(3) .row.cols-2{
  gap:12px !important; column-gap:12px !important; row-gap:12px !important;
}

/* –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É */
.page-header{
  display:flex; align-items:center; justify-content:space-between;
  flex-wrap:wrap; gap:12px; margin-bottom:16px;
}
.page-header .info{flex:1 1 auto;}
.user-panel{display:flex; align-items:center; gap:10px; flex-shrink:0;}
.user-panel .userpill{
  font-size:var(--fs-sm);
  padding:4px 10px;
  border-radius:30px;
  background:#f2f6ff;
  border:1px solid #dbe7ff;
  color:#1f4fbf;
  white-space:nowrap;
}
.user-panel button{
  padding:4px 10px;
  min-height:35px;
  border-radius:30px;
  border:1px solid var(--line);
  background:#fff;
  color:#111;
  font-weight:500;
  cursor:pointer;
  transition:border-color .2s ease, background .2s ease;
}
.user-panel button:hover{ border-color:#2d6cdf; background:#fff; color:#111 }

/* –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê/–®–†–ò–§–¢ */
@font-face{
  font-family:"SF Pro Display";
  font-style:normal;
  font-weight:100 900;
  src:local("SF Pro Display"), local("SFProDisplay-Regular");
  font-display:swap;
}
h1, h2, h3{
  font-weight:600;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  font-synthesis:none;
}

/* iOS/WebKit –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ date/month/select */
input[type="date"], input[type="month"]{
  -webkit-appearance:none; appearance:none;
  width:100%; min-height:48px; line-height:1.2; padding:12px 14px;
  border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit;
}
input[type="date"]::-webkit-date-and-time-value,
input[type="month"]::-webkit-date-and-time-value{ text-align:left }

/* –º–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ‚Äî –≤ —Ä—è–¥ —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º, —à—Ä–∏—Ñ—Ç 16 —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
@media (max-width:640px){
  .card .card-title{flex-direction:column; align-items:flex-start; gap:6px;}
  input, select, textarea{ font-size:16px }
  .page-header{flex-direction:column; align-items:flex-start;}
  .user-panel{width:100%; justify-content:flex-start;}
}

/* –¢–æ–ª—å–∫–æ –∫—Ä–µ—Å—Ç–∏–∫ ‚Äî –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∏–Ω–∏–º –≤ —Ç–∞–±–ª–∏—Ü–µ */
#txTable .btn-ghost {
  color: inherit; background:#fff; border:1px solid var(--line); border-radius:8px; padding:6px 10px; min-height:32px; cursor:pointer;
  transition: color .2s ease, border-color .2s ease, background .2s ease;
}
#txTable .btn-ghost:hover { color: var(--accent); border-color:#d4e1ff; }

/* –ö–Ω–æ–ø–∫–∏ –≤ —è—á–µ–π–∫–µ –¥–µ–π—Å—Ç–≤–∏–π */
.actions{display:flex; gap:8px; justify-content:flex-end; align-items:center;}
.icon{width:18px; height:18px; display:inline-block; vertical-align:middle;}
.icon svg{width:18px; height:18px; display:block}

/* —Å—Ç—Ä–µ–ª–∫–∞ —É select */
select{
  -webkit-appearance:none; -moz-appearance:none; appearance:none;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
  background-repeat:no-repeat;
  background-position:right 12px center;
  background-size:16px 16px;
  padding-right:40px;
}
select::-ms-expand{display:none;}

/* —Å–∫—Ä—ã—Ç—å –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
html, body { scrollbar-width: none; -ms-overflow-style: none; }
html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }

/* ===== –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ===== */
.backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center; padding:20px; z-index:999;
}
.backdrop[aria-hidden="false"]{ display:flex; }
[hidden]{ display:none !important; }

.modal{
  width:min(680px, 100%); background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
  padding:16px;
}
.modal h3{margin:0 0 8px}
.modal .controls{justify-content:flex-end}
.modal .row{gap:12px}
.modal .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:640px){ .modal .two{grid-template-columns:1fr} }

/* ===== Undo-—Ä–µ–∂–∏–º ===== */
.undo-wrap{display:flex; align-items:center; gap:8px; justify-content:flex-end;}
.undo-btn{border:1px solid #d4e1ff; background:#eaf1ff; color:#1f4fbf; border-radius:8px; min-height:32px; padding:6px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;}
.countdown{font-size:var(--fs-sm); color:var(--muted); border:1px dashed var(--line); border-radius:999px; padding:2px 8px; white-space:nowrap;}
.tr-pending{opacity:.65;}

/* ===========================
   >>> –ü–ê–¢–ß–ò –ü–û–î –ó–ê–î–ê–ß–£ <<<
   =========================== */

/* 1) –ï–î–ò–ù–ê–Ø –õ–ò–ù–ò–Ø –í –¢–ê–ë–õ–ò–¶–ï (–±–µ–∑ ¬´—Å—Ç—É–ø–µ–Ω—å–∫–∏¬ª –≤ actions) */
#txTable thead th{ border-bottom:1px solid var(--line); }  /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∫ –±—ã–ª */
#txTable tbody td{ border-bottom:none; }                    /* —É —Ç–µ–ª–∞ —É–±–∏—Ä–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã */
#txTable tbody tr{
  background-image: linear-gradient(to right, var(--line), var(--line));
  background-repeat: no-repeat;
  background-position: 0 100%;
  background-size: 100% 1px;                               /* –æ–¥–Ω–∞ —Ç–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è */
}
/* –†–æ–≤–Ω—ã–µ –ø–∞–¥–¥–∏–Ω–≥–∏ –∏ –≤—ã—Å–æ—Ç—ã */
#txTable td, #txTable th{ padding-top:10px; padding-bottom:10px; }
#txTable .actions{ min-height:32px; }
#txTable .btn-ghost, #txTable [data-edit]{ height:36px; min-height:36px; }

/* 2) –ï–î–ò–ù–´–ô –®–†–ò–§–¢ –í –ò–ù–ü–£–¢–ê–• –ù–ê –ú–û–ë–ê–ô–õ–ï */
input, select, textarea{
  font-weight:400 !important;
  -webkit-font-smoothing: antialiased;
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-text-size-adjust: 100%;
}

/* 3) –ù–ê –ê–î–ê–ü–¢–ò–í–ê–• (‚â§640) ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ Medium, –∏ –º–µ—Å—è—Ü —Å–ø—Ä–∞–≤–∞ –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
@media (max-width:640px){
  h1, h2, h3{ font-weight:500; } /* Medium –≤–º–µ—Å—Ç–æ Semibold/Bold */

  /* –í–û–ó–í–†–ê–©–ê–ï–ú —Ñ–ª–µ–∫—Å-—Ä—è–¥ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫,
     —á—Ç–æ–±—ã –±–µ–π–¥–∂ –º–µ—Å—è—Ü–∞ –±—ã–ª —Å–ø—Ä–∞–≤–∞ –æ—Ç ¬´–î–∞—à–±–æ—Ä–¥¬ª */
  .card .card-title{
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 8px !important;
  }
  .card .card-title h2{ margin:0; }

  /* 5) –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∞–π–ª–µ */
  #txTable button[data-del]{
    width:40px; aspect-ratio:1/1;
    padding:0; display:inline-flex; align-items:center; justify-content:center;
    border-radius:8px;
  }
  /* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ actions */
  #txTable .actions{ gap:6px; }
}
</style>
</head>
<body>
<div class="container">

  <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
  <div class="page-header">
    <div class="info">
      <h1>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
      <div class="muted">–£–¥–æ–±–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –¥–æ—Ö–æ–¥–∞ –∏ —Ä–∞—Å—Ö–æ–¥–∞</div>
    </div>
    <div class="user-panel">
      <span id="userEmail" class="userpill">‚Äî</span>
      <button class="ghost" id="btnSignOut">–°–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    </div>
  </div>

  <!-- –î–∞—à–±–æ—Ä–¥ -->
  <section class="card">
    <div class="card-title">
      <h2 style="margin:0">–î–∞—à–±–æ—Ä–¥</h2>
      <span class="badge" id="currentMonthBadge"></span>
    </div>

    <div class="kpis" style="margin-bottom:12px">
      <div class="kpi"><div class="muted">–î–æ—Ö–æ–¥—ã (–º–µ—Å—è—Ü)</div><b id="kpiIncomeMonth">‚Äî</b></div>
      <div class="kpi"><div class="muted">–†–∞—Å—Ö–æ–¥—ã (–º–µ—Å—è—Ü)</div><b id="kpiExpenseMonth">‚Äî</b></div>
      <div class="kpi"><div class="muted">–¢—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è</div><b id="kpiToday">‚Äî</b></div>
      <div class="kpi"><div class="muted">–ë–∞–ª–∞–Ω—Å –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤</div><b id="kpiTotal">‚Äî</b></div>
    </div>

    <div class="grid-accounts" id="accountsGrid"></div>

    <div style="margin-top:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px">
        <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞</div>
        <div class="muted" id="debtLabel">‚Äî</div>
      </div>
      <div class="progress"><i id="debtProgress" style="width:0%"></i></div>
    </div>
  </section>

  <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ -->
  <section class="row cols-3" style="margin-top:16px">
    <!-- –î–æ—Ö–æ–¥ -->
    <div class="card">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h3>
      <label>–î–∞—Ç–∞ <input type="date" id="incDate"></label>
      <label>–°—É–º–º–∞ ‚ÇΩ <input type="number" id="incAmount" min="0" step="0.01" placeholder="–ù–∞–ø—Ä. 100000"></label>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è <input type="text" id="incCategory" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞ / –§—Ä–∏–ª–∞–Ω—Å"></label>
      <label>–ó–∞–º–µ—Ç–∫–∞ <input type="text" id="incNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></label>
      <div class="help">–î–æ—Ö–æ–¥ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ 4 —Å—á–µ—Ç–∞–º —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–ª—è–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>
      <div class="controls">
        <button class="primary" id="btnAddIncome">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="ghost" id="btnPreviewSplit">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
      </div>
      <div id="splitPreview" class="help" style="display:none;margin-top:6px"></div>
    </div>

    <!-- –†–∞—Å—Ö–æ–¥ -->
    <div class="card">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h3>
      <label>–î–∞—Ç–∞ <input type="date" id="expDate"></label>
      <label>–°—É–º–º–∞ ‚ÇΩ <input type="number" id="expAmount" min="0" step="0.01" placeholder="–ù–∞–ø—Ä. 2500"></label>
      <label>–°—á—ë—Ç
        <select id="expAcc">
          <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
          <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
          <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
          <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
        </select>
      </label>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è <input type="text" id="expCategory" placeholder="–ï–¥–∞ / –ü–æ–¥–ø–∏—Å–∫–∏ / –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç"></label>
      <label>–ó–∞–º–µ—Ç–∫–∞ <input type="text" id="expNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></label>
      <div class="controls"><button class="primary" id="btnAddExpense">–î–æ–±–∞–≤–∏—Ç—å</button></div>
    </div>

    <!-- –ü–µ—Ä–µ–≤–æ–¥—ã / –î–æ–ª–≥ -->
    <div class="card" id="cardTransfers">
      <h3>–ü–µ—Ä–µ–≤–æ–¥—ã –∏ –¥–æ–ª–≥</h3>
      <details class="modal" style="margin-bottom:8px" open>
        <summary class="summary-row">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏ <small>–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π</small></summary>
        <div class="row" style="margin-top:8px">
          <div><label>–î–∞—Ç–∞ <input type="date" id="trDate"></label></div>
          <div><label>–°—É–º–º–∞ ‚ÇΩ <input type="number" id="trAmount" min="0" step="0.01"></label></div>
        </div>
        <div class="row cols-2">
          <label>–û—Ç–∫—É–¥–∞
            <select id="trFrom">
              <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
              <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
              <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
              <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
            </select>
          </label>
          <label>–ö—É–¥–∞
            <select id="trTo">
              <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
              <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
              <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
              <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
            </select>
          </label>
        </div>
        <label>–ó–∞–º–µ—Ç–∫–∞ <input type="text" id="trNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></label>
        <div class="controls"><button class="primary" id="btnTransfer">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button></div>
      </details>

      <details class="modal">
        <summary class="summary-row">–ü–ª–∞—Ç—ë–∂ –ø–æ –¥–æ–ª–≥—É <small>—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å</small></summary>
        <div class="row" style="margin-top:8px">
          <div><label>–î–∞—Ç–∞ <input type="date" id="debtDate"></label></div>
          <div><label>–°—É–º–º–∞ ‚ÇΩ <input type="number" id="debtPayAmount" min="0" step="0.01"></label></div>
        </div>
        <label>–°–ø–∏—Å–∞—Ç—å —Å —Å—á—ë—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          <select id="debtFrom">
            <option value="">‚Äî –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å ‚Äî</option>
            <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
            <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
            <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
            <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
          </select>
        </label>
        <label>–ó–∞–º–µ—Ç–∫–∞ <input type="text" id="debtNote" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ"></label>
        <div class="controls">
          <button class="primary" id="btnDebtPay">–£—á–µ—Å—Ç—å –ø–ª–∞—Ç—ë–∂</button>
          <button class="ghost" id="btnDebtReset">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>
      </details>
    </div>
  </section>

  <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
  <section class="card" style="margin-top:16px">
    <div class="card-title">
      <h2 style="margin:0">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
      <div class="controls">
        <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label>
          <input type="file" id="fileImport" accept="application/json" style="display:none">
          <button class="ghost" id="btnImport">–ò–º–ø–æ—Ä—Ç JSON</button>
        </label>
        <button class="danger" id="btnWipe">–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
      </div>
    </div>

    <div class="row cols-4" style="margin-bottom:8px">
      <label>–ú–µ—Å—è—Ü <input type="month" id="fltMonth"></label>
      <label>–¢–∏–ø
        <select id="fltType">
          <option value="">–í—Å–µ</option>
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞—Å—Ö–æ–¥</option>
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
          <option value="debt">–î–æ–ª–≥</option>
        </select>
      </label>
      <label>–°—á—ë—Ç
        <select id="fltAcc">
          <option value="">–í—Å–µ</option>
          <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
          <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
          <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
          <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
        </select>
      </label>
      <label>–ü–æ–∏—Å–∫ <input type="text" id="fltSearch" placeholder="–∫–∞—Ç–µ–≥–æ—Ä–∏—è/–∑–∞–º–µ—Ç–∫–∞"></label>
    </div>

    <div class="row cols-2">
      <div class="help" id="listInfo">‚Äî</div>
      <div style="text-align:right" class="help"><span class="tag">—Å–µ–≥–æ–¥–Ω—è: <b id="todayStr">‚Äî</b></span></div>
    </div>

    <div style="overflow:auto">
      <table class="table" id="txTable">
        <thead>
          <tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—á–µ—Ç–∞</th><th>–°—É–º–º–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ó–∞–º–µ—Ç–∫–∞</th><th style="width:160px"></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <section class="card" style="margin-top:16px">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <div class="row cols-4">
      <label>–ë–∞–∑–æ–≤—ã–π ‚ÇΩ <input type="number" id="stBase" min="0" step="0.01"></label>
      <label>–†–∞—Å—Ö–æ–¥–Ω—ã–π ‚ÇΩ <input type="number" id="stFixed" min="0" step="0.01"></label>
      <label>–í–µ—Å—ë–ª—ã–π ‚ÇΩ <input type="number" id="stFun" min="0" step="0.01"></label>
      <label>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è ‚ÇΩ <input type="number" id="stSave" min="0" step="0.01"></label>
    </div>
    <div class="row cols-4" style="margin-top:8px">
      <label>–°—É–º–º–∞ –¥–æ–ª–≥–∞ ‚ÇΩ <input type="number" id="stDebtTotal" min="0" step="0.01"></label>
      <label>–£–∂–µ –ø–æ–≥–∞—à–µ–Ω–æ ‚ÇΩ <input type="number" id="stDebtPaid" min="0" step="0.01"></label>
      <label>–ù–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞ (–¥–µ–Ω—å) <input type="number" id="stMonthStart" min="1" max="28"></label>
    </div>
    <h3 style="margin-top:12px">–î–æ–ª–∏ –∞–≤—Ç–æ-—Ä–∞—Å–∫–∏–¥–∫–∏ –¥–æ—Ö–æ–¥–∞ (%)</h3>
    <div class="row cols-4">
      <label>–ë–∞–∑–æ–≤—ã–π % <input type="number" id="spBase" min="0" max="100"></label>
      <label>–†–∞—Å—Ö–æ–¥–Ω—ã–π % <input type="number" id="spFixed" min="0" max="100"></label>
      <label>–í–µ—Å—ë–ª—ã–π % <input type="number" id="spFun" min="0" max="100"></label>
      <label>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è % <input type="number" id="spSave" min="0" max="100"></label>
    </div>
    <div class="help" id="splitSumHelp" style="margin-top:6px">–°—É–º–º–∞ –¥–æ–ª–µ–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%.</div>
    <div class="controls">
      <button class="primary" id="btnSaveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="ghost" id="btnFillDemo">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
    </div>
  </section>

  <footer>—Å–¥–µ–ª–∞–Ω–æ —Ä—É–∫–∞–º–∏ <a href="https://dmitry-design.ru/" target="_blank" rel="noopener">dmitry-design.ru</a></footer>
</div>

<!-- ===== –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ò ===== -->
<div id="editBackdrop" class="backdrop" hidden aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <h3 id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
    <div class="two" style="margin-top:8px">
      <label>–¢–∏–ø
        <select id="edType">
          <option value="income">–î–æ—Ö–æ–¥</option>
          <option value="expense">–†–∞—Å—Ö–æ–¥</option>
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
          <option value="debt">–î–æ–ª–≥</option>
        </select>
      </label>
      <label>–î–∞—Ç–∞ <input type="date" id="edDate"></label>
    </div>

    <div class="two">
      <label>–°—É–º–º–∞ ‚ÇΩ <input type="number" id="edAmount" min="0" step="0.01"></label>
      <div id="edAccountBox">
        <label>–°—á—ë—Ç
          <select id="edAccount">
            <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
            <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
            <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
            <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
          </select>
        </label>
      </div>
    </div>

    <div class="two" id="edTransferBox" style="display:none">
      <label>–û—Ç–∫—É–¥–∞
        <select id="edFrom">
          <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
          <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
          <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
          <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
        </select>
      </label>
      <label>–ö—É–¥–∞
        <select id="edTo">
          <option value="base">–ë–∞–∑–æ–≤—ã–π</option>
          <option value="fixed">–†–∞—Å—Ö–æ–¥–Ω—ã–π</option>
          <option value="fun">–í–µ—Å—ë–ª—ã–π</option>
          <option value="save">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
        </select>
      </label>
    </div>

    <div class="two">
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è <input type="text" id="edCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è"></label>
      <label>–ó–∞–º–µ—Ç–∫–∞ <input type="text" id="edNote" placeholder="–ó–∞–º–µ—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></label>
    </div>

    <div class="controls" style="margin-top:8px">
      <button id="btnCancelEdit" class="ghost">–û—Ç–º–µ–Ω–∞</button>
      <button id="btnSaveEdit" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Supabase SDK + APP -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== –£—Ç–∏–ª–∏—Ç—ã DOM/—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===== */
const $  = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const fmtRUB = n => (Number(n)||0).toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});
const fmtNum = (n,d=2) => (Number(n)||0).toLocaleString('ru-RU',{minimumFractionDigits:d,maximumFractionDigits:d});
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const todayISO = () => new Date().toISOString().slice(0,10);
const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
/* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –∑–∞–º–µ—Ç–∫–∏ */
const escapeHtml = (s='') => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ===========================
   –ò–ù–ò–¢ SUPABASE / –ì–í–ê–†–î
   =========================== */
const SUPABASE_URL = "https://hxbrvnwukieluzlffgyr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4YnJ2bnd1a2llbHV6bGZmZ3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NTM1NDMsImV4cCI6MjA3NzAyOTU0M30.IWViKSutxlXo1R3DqArijjeseK6nQ9m55ZPe5EUToLQ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* üîó –ù–æ–≤—ã–π –ø—É—Ç—å –∫ auth.html –ø–æ–¥ —Ç–≤–æ–∏–º –Ω–∏–∫–æ–º */
const AUTH_URL  = "https://cdn-dmitry-design.github.io/Personal-Money-Tracker-2.0/auth.html";

/* –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—É—é –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ */
(() => { const bg = document.getElementById('editBackdrop'); if (bg) { bg.setAttribute('aria-hidden','true'); bg.hidden = true; } })();

(async () => {
  // guard ‚Äî –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Üí –Ω–∞ auth
  const { data: { session} } = await supabase.auth.getSession();
  if(!(session && session.user)){ location.href = AUTH_URL; return; }
  const USER_ID = session.user.id;
  $("#userEmail").textContent = session.user.email || USER_ID;

  $("#btnSignOut").onclick = async () => {
    try{ await supabase.auth.signOut(); }catch(e){}
    localStorage.removeItem("dm_user_id");
    location.href = AUTH_URL;
  };

  /* ===========================
     PERSISTENCE (LS + Cloud)
     =========================== */
  const LS_KEY = `dm_fin_v1_${USER_ID}`;

  function loadLocal(){
    try{ const raw = localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw); }catch(e){}
    return {
      meta:{ seq:0 },
      settings:{
        accounts:{ base:0,fixed:0,fun:0,save:0,debtTotal:0,debtPaid:0 },
        autosplit:{ base:40,fixed:30,fun:10,save:20 },
        monthStartDay:1
      },
      transactions:[]
    };
  }
  function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  async function loadCloud(){
    try{
      const { data, error } = await supabase.from('users_fintracker').select('data').eq('user_id', USER_ID).maybeSingle();
      if(error) throw error;
      if(data && data.data && Object.keys(data.data).length){
        state = data.data;
        if(!state.meta) state.meta = { seq:0 };
        saveLocal();
      }
    }catch(e){ console.warn('loadCloud:', e.message); }
  }
  async function saveCloud(){
    try{ await supabase.from('users_fintracker').update({ data: state }).eq('user_id', USER_ID); }
    catch(e){ console.warn('saveCloud:', e.message); }
  }
  function save(){ saveLocal(); saveCloud(); }

  // state + –º–∏–≥—Ä–∞—Ü–∏–∏
  let state = loadLocal();
  await loadCloud();

  // MIGRATION _order
  (function migrateOrder(){
    if(!state.meta) state.meta = { seq:0 };
    let changed = false;
    for(const t of state.transactions){
      if(typeof t._order !== 'number'){
        state.meta.seq += 1;
        t._order = state.meta.seq;
        changed = true;
      }
    }
    if(changed) save();
  })();

  function nextSeq(){ state.meta.seq += 1; return state.meta.seq; }

  /* ===========================
     INIT UI
     =========================== */
  $('#incDate').value = todayISO();
  $('#expDate').value = todayISO();
  $('#trDate').value = todayISO();
  $('#debtDate').value = todayISO();

  function initMonthFilter(){
    const def = new Date().toISOString().slice(0,7);
    $('#fltMonth').value = def;
  }
  initMonthFilter();

  function fillSettingsUI(){
    const A = state.settings.accounts;
    $('#stBase').value=A.base; $('#stFixed').value=A.fixed; $('#stFun').value=A.fun; $('#stSave').value=A.save;
    $('#stDebtTotal').value=A.debtTotal; $('#stDebtPaid').value=A.debtPaid; $('#stMonthStart').value=state.settings.monthStartDay;
    $('#spBase').value=state.settings.autosplit.base; $('#spFixed').value=state.settings.autosplit.fixed; $('#spFun').value=state.settings.autosplit.fun; $('#spSave').value=state.settings.autosplit.save;
    updateSplitSumHelp();
  }
  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
  function updateSplitSumHelp(){
    const sum = ['base','fixed','fun','save'].reduce((s,k)=>s+Number($('#sp'+cap(k)).value||0),0);
    $('#splitSumHelp').textContent = `–°—É–º–º–∞ –¥–æ–ª–µ–π: ${sum}% (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 100%).`;
    $('#splitSumHelp').style.color = (sum===100)? 'var(--muted)' : '#c0392b';
  }
  ['spBase','spFixed','spFun','spSave'].forEach(id => $('#'+id).addEventListener('input', updateSplitSumHelp));

  function renderDashboard(){
    const month = $('#fltMonth').value || new Date().toISOString().slice(0,7);
    const [y,m] = month.split('-').map(Number);
    $('#currentMonthBadge').textContent = new Date(y, m-1, 1).toLocaleString('ru-RU',{month:'long',year:'numeric'});

    const A = state.settings.accounts;
    const accs = [
      {key:'base',title:'–ë–∞–∑–æ–≤—ã–π',hint:'–∑–∞—Ä–ø–ª–∞—Ç–∞'},
      {key:'fixed',title:'–†–∞—Å—Ö–æ–¥–Ω—ã–π',hint:'—Ñ–∏–∫—Å. –ø–ª–∞—Ç–µ–∂–∏'},
      {key:'fun',title:'–í–µ—Å—ë–ª—ã–π',hint:'—É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è'},
      {key:'save',title:'–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è',hint:'—Ü–µ–ª–∏/–ø–æ–¥—É—à–∫–∞'},
      {key:'debt',title:'–î–æ–ª–≥',hint:'–æ—Å—Ç–∞—ë—Ç—Å—è'}
    ];
    const grid = $('#accountsGrid'); grid.innerHTML='';
    accs.forEach(a=>{
      const val = (a.key==='debt') ? Math.max(A.debtTotal - A.debtPaid, 0) : A[a.key];
      const div = document.createElement('div');
      div.className='account';
      div.innerHTML = `<h4>${a.title}</h4><div class="sum">${fmtRUB(val)}</div><div class="hint">${a.hint}</div>`;
      grid.appendChild(div);
    });

    const pct = (A.debtTotal>0)? clamp((A.debtPaid/A.debtTotal)*100,0,100):0;
    $('#debtProgress').style.width = pct.toFixed(1)+'%';
    $('#debtLabel').textContent = `${fmtRUB(A.debtPaid)} –∏–∑ ${fmtRUB(A.debtTotal)} (${pct.toFixed(1)}%)`;

    const listM = state.transactions.filter(t => (t.date||'').startsWith(month));
    const sumIncome = listM.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const sumExpense = listM.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    $('#kpiIncomeMonth').textContent = fmtRUB(sumIncome);
    $('#kpiExpenseMonth').textContent = fmtRUB(sumExpense);

    const tISO = todayISO();
    const todayExp = state.transactions.filter(t=>t.type==='expense' && t.date===tISO).reduce((s,t)=>s+t.amount,0);
    $('#kpiToday').textContent = fmtRUB(todayExp);

    const totalBal = A.base + A.fixed + A.fun + A.save;
    $('#kpiTotal').textContent = fmtRUB(totalBal);

    $('#todayStr').textContent = new Date().toLocaleDateString('ru-RU');
  }

  function labelAcc(k){ return ({base:'–ë–∞–∑–æ–≤—ã–π', fixed:'–†–∞—Å—Ö–æ–¥–Ω—ã–π', fun:'–í–µ—Å—ë–ª—ã–π', save:'–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è'})[k] || '‚Äî'; }
  function labelType(t){ return ({income:'–î–æ—Ö–æ–¥', expense:'–†–∞—Å—Ö–æ–¥', transfer:'–ü–µ—Ä–µ–≤–æ–¥', debt:'–î–æ–ª–≥'})[t] || t; }

  /* ===== Undo-–æ—á–µ—Ä–µ–¥—å ===== */
  const pendingDeletes = new Map();
  function startPendingDelete(id){
    if(pendingDeletes.has(id)){
      clearInterval(pendingDeletes.get(id).timer);
      pendingDeletes.delete(id);
    }
    const until = Date.now() + 10000;
    const timer = setInterval(() => {
      const span = document.querySelector(`[data-countdown="${id}"]`);
      if(span){
        const left = Math.max(0, Math.ceil((until - Date.now())/1000));
        span.textContent = left + '—Å';
      }
      if(Date.now() >= until){
        clearInterval(timer);
        pendingDeletes.delete(id);
        const old = state.transactions.find(x=>x.id===id);
        if(old){
          applyTx(old, -1);
          state.transactions = state.transactions.filter(t=>t.id!==id);
          save(); renderAll();
        }else{
          renderTable();
        }
      }
    }, 250);
    pendingDeletes.set(id, {until, timer});
    renderTable();
  }
  function cancelPending(id){
    const rec = pendingDeletes.get(id);
    if(rec){ clearInterval(rec.timer); pendingDeletes.delete(id); }
    renderTable();
  }

  /* ====== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶–´ ====== */
  function renderTable(){
    const month = $('#fltMonth').value || new Date().toISOString().slice(0,7);
    const tp = $('#fltType').value;
    const acc = $('#fltAcc').value;
    const q = ($('#fltSearch').value||'').trim().toLowerCase();

    let list = state.transactions.slice();
    list = list.filter(t => (t.date||'').startsWith(month));
    if(tp)  list = list.filter(t => t.type===tp);
    if(acc) list = list.filter(t => t.account===acc || t.fromAccount===acc || t.toAccount===acc);
    if(q)   list = list.filter(t => ((t.category||'')+(t.note||'')).toLowerCase().includes(q));

    list.sort((a,b)=> (a._order||0) - (b._order||0));

    const tbody = $('#txTable tbody'); tbody.innerHTML = '';
    for(const t of list){
      const accounts = (
        t.type==='transfer' ? `${labelAcc(t.fromAccount)} ‚Üí ${labelAcc(t.toAccount)}` :
        t.type==='income'   ? `${labelAcc(t.account)} (+)` :
        t.type==='expense'  ? `${labelAcc(t.account)} (‚àí)` :
        t.type==='debt'     ? `–î–æ–ª–≥${t.account? ' (‚àí '+labelAcc(t.account)+')':''}` : ''
      );
      const tr = document.createElement('tr');
      const isPending = pendingDeletes.has(t.id);
      tr.className = isPending ? 'tr-pending' : '';
      tr.innerHTML = `
        <td>${t.date}</td>
        <td><span class="tag">${labelType(t.type)}</span></td>
        <td>${accounts||'‚Äî'}</td>
        <td style="white-space:nowrap">${(t.type==='expense'||(t.type==='transfer'&&t.fromAccount))?'-':''}${fmtNum(t.amount,0)} ‚ÇΩ</td>
        <td>${t.category||'‚Äî'}</td>
        <td><span class="note-clip">${escapeHtml(t.note||'')}</span></td>
        <td class="actions">
          ${isPending ? `
            <div class="undo-wrap">
              <button class="undo-btn" data-undo="${t.id}" title="–û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ">
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 14l-4-4 4-4"/><path d="M20 20a9 9 0 0 0-9-9H5"/>
                  </svg>
                </span>
                –û—Ç–º–µ–Ω–∞
              </button>
              <span class="countdown" data-countdown="${t.id}">10—Å</span>
            </div>
          ` : `
            <button class="btn-ghost" data-edit="${t.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
              <span class="icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
                </svg>
              </span>
            </button>
            <button class="btn-ghost" data-del="${t.id}" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
          `}
        </td>
      `;
      tbody.appendChild(tr);
    }

    $('#listInfo').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${list.length} –æ–ø–µ—Ä–∞—Ü–∏–π. –í—Å–µ–≥–æ –≤ –±–∞–∑–µ: ${state.transactions.length}.`;

    $$('button[data-del]').forEach(btn=>{ btn.onclick = () => startPendingDelete(btn.getAttribute('data-del')); });
    $$('button[data-undo]').forEach(btn=>{ btn.onclick = () => cancelPending(btn.getAttribute('data-undo')); });
    $$('button[data-edit]').forEach(btn=>{ btn.onclick = () => openEdit(btn.getAttribute('data-edit')); });
  }

  /* ===========================
     –î–û–ë–ê–í–õ–ï–ù–ò–ï
     =========================== */
  $('#btnPreviewSplit').onclick = () => {
    const amount = Number($('#incAmount').value||0);
    const preview = $('#splitPreview');
    if(!amount){ preview.style.display='none'; return; }
    const s = state.settings.autosplit;
    const p = {
      base: Math.round(amount*(s.base/100)),
      fixed: Math.round(amount*(s.fixed/100)),
      fun:   Math.round(amount*(s.fun/100)),
      save:  Math.round(amount*(s.save/100))
    };
    const sum = p.base+p.fixed+p.fun+p.save;
    const delta = Math.round(amount - sum);
    if(delta!==0) p.base += delta;
    preview.style.display='block';
    preview.textContent = `–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ë–∞–∑–æ–≤—ã–π ${p.base.toLocaleString('ru-RU')} ‚ÇΩ, –†–∞—Å—Ö–æ–¥–Ω—ã–π ${p.fixed.toLocaleString('ru-RU')} ‚ÇΩ, –í–µ—Å—ë–ª—ã–π ${p.fun.toLocaleString('ru-RU')} ‚ÇΩ, –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è ${p.save.toLocaleString('ru-RU')} ‚ÇΩ.`;
  };

  $('#btnAddIncome').onclick = () => {
    const date = $('#incDate').value || todayISO();
    const amount = Number($('#incAmount').value||0);
    const category = ($('#incCategory').value||'–î–æ—Ö–æ–¥');
    const note = ($('#incNote').value||'');
    if(amount<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞ > 0');
    const s = state.settings.autosplit;
    const split = {
      base: Math.round(amount*(s.base/100)),
      fixed: Math.round(amount*(s.fixed/100)),
      fun:   Math.round(amount*(s.fun/100)),
      save:  Math.round(amount*(s.save/100))
    };
    const sum = split.base + split.fixed + split.fun + split.save;
    const delta = Math.round(amount - sum);
    if(delta!==0) split.base += delta;
    for(const k of ['base','fixed','fun','save']){
      if(split[k] > 0){
        const tx = { id:uid(), _order: nextSeq(), date, type:'income', account:k, amount:split[k], category, note };
        state.transactions.push(tx);
        applyTx(tx, +1);
      }
    }
    save();
    $('#incAmount').value=''; $('#incNote').value=''; $('#splitPreview').style.display='none';
    renderAll();
  };

  $('#btnAddExpense').onclick = () => {
    const date = $('#expDate').value || todayISO();
    const amount = Number($('#expAmount').value||0);
    const account = $('#expAcc').value;
    const category = ($('#expCategory').value||'–†–∞—Å—Ö–æ–¥');
    const note = ($('#expNote').value||'');
    if(amount<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ > 0');
    if(state.settings.accounts[account] < amount){
      if(!confirm('–ù–∞ —Å—á—ë—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    }
    const tx = { id:uid(), _order: nextSeq(), date, type:'expense', account, amount, category, note };
    state.transactions.push(tx);
    applyTx(tx, +1);
    save();
    $('#expAmount').value=''; $('#expNote').value='';
    renderAll();
  };

  $('#btnTransfer').onclick = () => {
    const date = $('#trDate').value || todayISO();
    const amount = Number($('#trAmount').value||0);
    const from = $('#trFrom').value;
    const to = $('#trTo').value;
    const note = ($('#trNote').value||'');
    if(amount<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞ > 0');
    if(from===to) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—á–µ—Ç–∞');
    if(state.settings.accounts[from] < amount){
      if(!confirm('–ù–∞ —Å—á—ë—Ç–µ-–∏—Å—Ç–æ—á–Ω–∏–∫–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    }
    const tx = { id:uid(), _order: nextSeq(), date, type:'transfer', fromAccount:from, toAccount:to, amount, category:'–ü–µ—Ä–µ–≤–æ–¥', note };
    state.transactions.push(tx);
    applyTx(tx, +1);
    save();
    $('#trAmount').value=''; $('#trNote').value='';
    renderAll();
  };

  $('#btnDebtPay').onclick = () => {
    const date = $('#debtDate').value || todayISO();
    const amount = Number($('#debtPayAmount').value||0);
    const from = $('#debtFrom').value;
    const note = ($('#debtNote').value||'');
    if(amount<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞ > 0');
    if(from && state.settings.accounts[from] < amount){
      if(!confirm('–ù–∞ —Å—á—ë—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    }
    const tx = { id:uid(), _order: nextSeq(), date, type:'debt', amount, account:from || undefined, category:'–ü–ª–∞—Ç—ë–∂ –ø–æ –¥–æ–ª–≥—É', note };
    state.transactions.push(tx);
    applyTx(tx, +1);
    save();
    $('#debtPayAmount').value=''; $('#debtNote').value='';
    renderAll();
  };
  $('#btnDebtReset').onclick = () => {
    if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞?')){
      state.settings.accounts.debtPaid = 0; save(); renderAll();
    }
  };

  /* ===========================
     APPLY/REVERT
     =========================== */
  function applyTx(tx, sign){
    const A = state.settings.accounts;
    const amt = Number(tx.amount)||0;
    if(tx.type === 'income'){
      if(tx.account) A[tx.account] += sign*amt;
    } else if(tx.type === 'expense'){
      if(tx.account) A[tx.account] -= sign*amt;
    } else if(tx.type === 'transfer'){
      if(tx.fromAccount) A[tx.fromAccount] -= sign*amt;
      if(tx.toAccount)   A[tx.toAccount]   += sign*amt;
    } else if(tx.type === 'debt'){
      A.debtPaid = clamp((A.debtPaid + sign*amt), 0, A.debtTotal);
      if(tx.account) A[tx.account] -= sign*amt;
    }
  }

  /* ===========================
     –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï
     =========================== */
  let editingId = null;

  function showEditUIByType(tp){
    $('#edAccountBox').style.display  = (tp==='income'||tp==='expense'||tp==='debt') ? '' : 'none';
    $('#edTransferBox').style.display = (tp==='transfer') ? '' : 'none';
  }

  function openEdit(id){
    cancelPending(id);
    const tx = state.transactions.find(x=>x.id===id);
    if(!tx) return;
    editingId = id;

    $('#edType').value = tx.type;
    $('#edDate').value = tx.date || todayISO();
    $('#edAmount').value = tx.amount ?? 0;
    $('#edCategory').value = tx.category || '';
    $('#edNote').value = tx.note || '';

    if(tx.type==='income' || tx.type==='expense' || tx.type==='debt'){
      $('#edAccount').value = tx.account || 'base';
    } else {
      $('#edAccount').value = 'base';
    }
    if(tx.type==='transfer'){
      $('#edFrom').value = tx.fromAccount || 'base';
      $('#edTo').value   = tx.toAccount || 'save';
    } else {
      $('#edFrom').value = 'base';
      $('#edTo').value   = 'save';
    }

    showEditUIByType(tx.type);
    const bg = $('#editBackdrop');
    bg.hidden = false; bg.setAttribute('aria-hidden','false');
    setTimeout(()=>$('#btnSaveEdit').focus(), 0);
  }

  $('#edType').addEventListener('change', (e)=> showEditUIByType(e.target.value));

  function closeEdit(){
    const bg = $('#editBackdrop');
    bg.hidden = true; bg.setAttribute('aria-hidden','true');
    editingId = null;
  }
  $('#btnCancelEdit').onclick = closeEdit;
  $('#editBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='editBackdrop') closeEdit(); });
  window.addEventListener('keydown', (e)=>{ if(!$('#editBackdrop').hidden && e.key==='Escape') closeEdit(); });

  $('#btnSaveEdit').onclick = () => {
    if(!editingId) return;
    const idx = state.transactions.findIndex(x=>x.id===editingId);
    if(idx<0) return;
    const old = state.transactions[idx];

    const tp = $('#edType').value;
    const date = $('#edDate').value || todayISO();
       const amount = Number($('#edAmount').value||0);
    const category = ($('#edCategory').value||'').trim() || (tp==='income'?'–î–æ—Ö–æ–¥': tp==='expense'?'–†–∞—Å—Ö–æ–¥': tp==='transfer'?'–ü–µ—Ä–µ–≤–æ–¥':'–ü–ª–∞—Ç—ë–∂ –ø–æ –¥–æ–ª–≥—É');
    const note = ($('#edNote').value||'');
    if(amount<=0) return alert('–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0');

    const draft = { id: old.id, _order: old._order, date, type: tp, amount, category, note };
    if(tp==='income' || tp==='expense' || tp==='debt'){
      draft.account = $('#edAccount').value;
    }
    if(tp==='transfer'){
      draft.fromAccount = $('#edFrom').value;
      draft.toAccount = $('#edTo').value;
      if(draft.fromAccount === draft.toAccount) return alert('–î–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Å—á–µ—Ç–∞.');
    }

    // –æ—Ç–∫–∞—Ç —Å—Ç–∞—Ä–æ–π
    applyTx(old, -1);

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ —Å—Ä–µ–¥—Å—Ç–≤
    const A = state.settings.accounts;
    const needConfirm = (
      (tp==='expense' && A[draft.account] < amount) ||
      (tp==='transfer' && A[draft.fromAccount] < amount) ||
      (tp==='debt' && draft.account && A[draft.account] < amount)
    );
    if(needConfirm){
      const ok = confirm('–ù–∞ —Å—á—ë—Ç–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
      if(!ok){ applyTx(old, +1); return; }
    }

    // –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–π
    state.transactions[idx] = draft;
    applyTx(draft, +1);
    save();
    renderAll();
    closeEdit();
  };

  /* ===========================
     –§–ò–õ–¨–¢–†–´/–ù–ê–°–¢–†–û–ô–ö–ò/–ò–ú–ü–û–†–¢/–≠–ö–°–ü–û–†–¢
     =========================== */
  $('#fltMonth').oninput = () => { renderDashboard(); renderTable(); };
  $('#fltType').oninput  = renderTable;
  $('#fltAcc').oninput   = renderTable;
  $('#fltSearch').oninput= renderTable;

  $('#btnSaveSettings').onclick = () => {
    const A = state.settings.accounts;
    A.base = Number($('#stBase').value||0);
    A.fixed= Number($('#stFixed').value||0);
    A.fun  = Number($('#stFun').value||0);
    A.save = Number($('#stSave').value||0);
    A.debtTotal = Number($('#stDebtTotal').value||0);
    A.debtPaid  = Number($('#stDebtPaid').value||0);

    state.settings.autosplit = {
      base:Number($('#spBase').value||0),
      fixed:Number($('#spFixed').value||0),
      fun:Number($('#spFun').value||0),
      save:Number($('#spSave').value||0)
    };
    state.settings.monthStartDay = Math.max(1, Math.min(28, Number($('#stMonthStart').value||1)));

    const sum = Object.values(state.settings.autosplit).reduce((s,n)=>s+Number(n||0),0);
    if(sum!==100) return alert('–°—É–º–º–∞ –¥–æ–ª–µ–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%.');

    save(); renderAll();
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
  };

  function isoShift(days){ const d = new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

  $('#btnFillDemo').onclick = () => {
    if(!confirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â–∏–µ?')) return;
    state = {
      meta:{ seq:0 },
      settings:{
        accounts:{ base:35000, fixed:20000, fun:7000, save:45000, debtTotal:300000, debtPaid:65000 },
        autosplit:{ base:40, fixed:30, fun:10, save:20 },
        monthStartDay:1
      },
      transactions:[]
    };
    const demo = [
      {date: isoShift(-25), type:'income',  account:'base',  amount:60000, category:'–ó–∞—Ä–ø–ª–∞—Ç–∞', note:'–∞–≤—Ç–æ—Å–ø–ª–∏—Ç'},
      {date: isoShift(-25), type:'income',  account:'fixed', amount:45000, category:'–ó–∞—Ä–ø–ª–∞—Ç–∞', note:'–∞–≤—Ç–æ—Å–ø–ª–∏—Ç'},
      {date: isoShift(-25), type:'income',  account:'fun',   amount:15000, category:'–ó–∞—Ä–ø–ª–∞—Ç–∞', note:'–∞–≤—Ç–æ—Å–ø–ª–∏—Ç'},
      {date: isoShift(-25), type:'income',  account:'save',  amount:30000, category:'–ó–∞—Ä–ø–ª–∞—Ç–∞', note:'–∞–≤—Ç–æ—Å–ø–ª–∏—Ç'},
      {date: isoShift(-7),  type:'expense', account:'fixed', amount:12000, category:'–ê—Ä–µ–Ω–¥–∞', note:''},
      {date: isoShift(-6),  type:'expense', account:'fixed', amount:1500,  category:'–°–≤—è–∑—å', note:''},
      {date: isoShift(-5),  type:'expense', account:'base',  amount:2200,  category:'–ï–¥–∞', note:'—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç'},
      {date: isoShift(-4),  type:'transfer',fromAccount:'base', toAccount:'save', amount:5000, category:'–ü–µ—Ä–µ–≤–æ–¥', note:'–Ω–∞ –ø–æ–¥—É—à–∫—É'},
      {date: isoShift(-3),  type:'expense', account:'fun',   amount:3000, category:'–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', note:'–∫–∏–Ω–æ/–±–∞—Ä'},
      {date: isoShift(-2),  type:'debt',    amount:15000, account:'base', category:'–ü–ª–∞—Ç—ë–∂ –ø–æ –¥–æ–ª–≥—É', note:'–ø–æ–≥–∞—à–µ–Ω–∏–µ'}
    ];
    for(const t of demo){
      state.meta.seq += 1;
      const tx = { id:uid(), _order: state.meta.seq, ...t };
      state.transactions.push(tx);
      applyTx(tx, +1);
    }
    save(); initMonthFilter(); renderAll();
  };

  $('#btnExport').onclick = () => {
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dm_fin_${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnImport').onclick = () => { $('#fileImport').click(); };
  $('#fileImport').onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.settings || !data.transactions) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      if(!data.meta) data.meta = { seq:0 };
      let seq = data.meta.seq || 0;

      for(const t of data.transactions){
        if(typeof t._order !== 'number'){ seq += 1; t._order = seq; }
      }
      data.meta.seq = Math.max(seq, data.meta.seq||0);

      state = { ...state, meta:data.meta, settings:data.settings, transactions:[] };
      state.settings.accounts.base = 0;
      state.settings.accounts.fixed = 0;
      state.settings.accounts.fun = 0;
      state.settings.accounts.save = 0;
      state.settings.accounts.debtPaid = 0;

      for(const t of data.transactions.sort((a,b)=> (a._order||0)-(b._order||0))){
        state.transactions.push(t);
        applyTx(t, +1);
      }
      save(); initMonthFilter(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.');
    }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message); }
    finally{ e.target.value = ''; }
  };

  /* –ê–∫–∫–æ—Ä–¥–µ–æ–Ω –≤ –±–ª–æ–∫–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤/–¥–æ–ª–≥–∞ */
  (function initAccordion(){
    const items = $$('#cardTransfers details.modal');
    items.forEach(d => d.addEventListener('toggle', () => {
      if(d.open){ items.forEach(x => { if(x!==d) x.open = false; }); }
    }));
  })();

  function renderAll(){ fillSettingsUI(); renderDashboard(); renderTable(); }
  renderAll();
})();

/* –î–æ–ø. —Ñ–∏–∫—Å –¥–ª—è iOS: –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ Safari ¬´–∂–∏—Ä–Ω–∏—Ç¬ª —Ç–µ–∫—Å—Ç –≤ –∏–Ω–ø—É—Ç–∞—Ö */
(function fixIOSBold(){
  const ua = navigator.userAgent || "";
  if(/(iPhone|iPad|iPod)/.test(ua)){
    document.addEventListener('focusin', e=>{
      if(e.target && /^(INPUT|TEXTAREA|SELECT)$/.test(e.target.tagName)){
        e.target.style.fontWeight = '400';
      }
    });
  }
})();
</script>
</body>
</html>

